#!/bin/bash
# Refresh Whoop access token using refresh token
# Run this before token expires (every ~50 min) or when you get 401

set -e
source "${WHOOP_ENV_FILE:-$HOME/.openclaw/credentials/whoop.env}"

RESPONSE=$(curl -s -X POST "$WHOOP_TOKEN_URL" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "grant_type=refresh_token" \
  -d "refresh_token=${WHOOP_REFRESH_TOKEN}" \
  -d "client_id=${WHOOP_CLIENT_ID}" \
  -d "client_secret=${WHOOP_CLIENT_SECRET}" \
  -d "scope=offline")

# Check for error
if echo "$RESPONSE" | grep -q '"error"'; then
  echo "Error refreshing token:"
  echo "$RESPONSE" | jq
  exit 1
fi

# Extract new tokens
NEW_ACCESS=$(echo "$RESPONSE" | jq -r '.access_token')
NEW_REFRESH=$(echo "$RESPONSE" | jq -r '.refresh_token')

if [ "$NEW_ACCESS" == "null" ] || [ -z "$NEW_ACCESS" ]; then
  echo "Failed to get new access token"
  echo "$RESPONSE"
  exit 1
fi

# Update credentials file
ENV_FILE="${WHOOP_ENV_FILE:-$HOME/.openclaw/credentials/whoop.env}"
sed -i "s|^WHOOP_ACCESS_TOKEN=.*|WHOOP_ACCESS_TOKEN=\"${NEW_ACCESS}\"|" "$ENV_FILE"
sed -i "s|^WHOOP_REFRESH_TOKEN=.*|WHOOP_REFRESH_TOKEN=\"${NEW_REFRESH}\"|" "$ENV_FILE"

echo "âœ“ Tokens refreshed successfully"
echo "  Access token: ${NEW_ACCESS:0:20}..."
echo "  Refresh token: ${NEW_REFRESH:0:20}..."
